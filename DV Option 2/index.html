<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>DV Option 2</title>
    <link rel="stylesheet" href="./style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet"
    />
    <script
      src="https://kit.fontawesome.com/25a68f228e.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script type="text/javascript" src="papaparse.min.js"></script>
  </head>
  <body>
    <main>
      <h1>DV Option 2</h1>
      <table>
        <tr>
          <th id="sunday-header">Sunday</th>
          <th id="monday-header">Monday</th>
          <th id="tuesday-header">Tuesday</th>
          <th id="wednesday-header">Wednesday</th>
          <th id="thursday-header">Thursday</th>
          <th id="friday-header">Friday</th>
          <th id="saturday-header">Saturday</th>
        </tr>
        <tr>
          <td id="sunday-cell"><p class="date">26</p></td>
          <td id="monday-cell"><p class="date">27</p></td>
          <td id="tuesday-cell"><p class="date">28</p></td>
          <td id="wednesday-cell"><p class="date">29</p></td>
          <td id="thursday-cell"><p class="date">30</p></td>
          <td id="friday-cell"><p class="date">1</p></td>
          <td id="saturday-cell"><p class="date">2</p></td>
        </tr>
      </table>
      <div id="cards">
        <div id="sunday-card" class="info">
          <div class="sunday-triangle"></div>
          <div class="card">
            <h2>Sunday</h2>
            <p id="day1-sleep"></p>
            <p id="day1-mood"></p>
            <div class="content">
              <div class="content-box" id="day1-temperature-graph"></div>
              <div class="content-box" id="day1-humidity-graph"></div>
            </div>
            <div class="content">
              <div class="content-box" id="day1-humidex-graph"></div>
              <div class="content-box" id="day1-light-graph"></div>
            </div>
          </div>
        </div>
        <div id="monday-card" class="info">
          <div class="monday-triangle"></div>
          <div class="card">
            <h2>Monday</h2>
            <p id="day2-sleep"></p>
            <p id="day2-mood"></p>
            <div class="content">
              <div class="content-box" id="day2-temperature-graph"></div>
              <div class="content-box" id="day2-humidity-graph"></div>
            </div>
            <div class="content">
              <div class="content-box" id="day2-humidex-graph"></div>
              <div class="content-box" id="day2-light-graph"></div>
            </div>
          </div>
        </div>
        <div id="tuesday-card" class="info">
          <div class="tuesday-triangle"></div>
          <div class="card">
            <h2>Tuesday</h2>
            <p id="day3-sleep"></p>
            <p id="day3-mood"></p>
            <div class="content">
              <div class="content-box" id="day3-temperature-graph"></div>
              <div class="content-box" id="day3-humidity-graph"></div>
            </div>
            <div class="content">
              <div class="content-box" id="day3-humidex-graph"></div>
              <div class="content-box" id="day3-light-graph"></div>
            </div>
          </div>
        </div>
        <div id="wednesday-card" class="info">
          <div class="wednesday-triangle"></div>
          <div class="card">
            <h2>Tuesday</h2>
            <p id="day4-sleep"></p>
            <p id="day4-mood"></p>
            <div class="content">
              <div class="content-box" id="day4-temperature-graph"></div>
              <div class="content-box" id="day4-humidity-graph"></div>
            </div>
            <div class="content">
              <div class="content-box" id="day4-humidex-graph"></div>
              <div class="content-box" id="day4-light-graph"></div>
            </div>
          </div>
        </div>
        <div id="thursday-card" class="info">
          <div class="thursday-triangle"></div>
          <div class="card">
            <h2>Tuesday</h2>
            <p id="day5-sleep"></p>
            <p id="day5-mood"></p>
            <div class="content">
              <div class="content-box" id="day5-temperature-graph"></div>
              <div class="content-box" id="day5-humidity-graph"></div>
            </div>
            <div class="content">
              <div class="content-box" id="day5-humidex-graph"></div>
              <div class="content-box" id="day5-light-graph"></div>
            </div>
          </div>
        </div>
        <div id="friday-card" class="info">
          <div class="friday-triangle"></div>
          <div class="card">
            <h2>Tuesday</h2>
            <p id="day6-sleep"></p>
            <p id="day6-mood"></p>
            <div class="content">
              <div class="content-box" id="day6-temperature-graph"></div>
              <div class="content-box" id="day6-humidity-graph"></div>
            </div>
            <div class="content">
              <div class="content-box" id="day6-humidex-graph"></div>
              <div class="content-box" id="day6-light-graph"></div>
            </div>
          </div>
        </div>
        <div id="saturday-card" class="info">
          <div class="saturday-triangle"></div>
          <div class="card">
            <h2>Tuesday</h2>
            <p id="day7-sleep"></p>
            <p id="day7-mood"></p>
            <div class="content">
              <div class="content-box" id="day7-temperature-graph"></div>
              <div class="content-box" id="day7-humidity-graph"></div>
            </div>
            <div class="content">
              <div class="content-box" id="day7-humidex-graph"></div>
              <div class="content-box" id="day7-light-graph"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </body>
  <script type="text/javascript">
    const filesToParse = [
      "https://emily.louie.ca/syde361-data/Recording_1.csv",
      "https://emily.louie.ca/syde361-data/daily_mood_ratings.csv",
      // daily_mood_ratings.csv must be the last one
    ];

    const parseFiles = (files) => {
      const filesData = []; // Array to save file data
      Promise.all(
        // Parse each file
        [...files].map(
          (file) =>
            new Promise((resolve, reject) =>
              Papa.parse(file, {
                header: true,
                download: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: resolve, // Resolve each promise
                error: reject, // Reject if there is an error
              })
            )
        )
      )
        .then((results) => {
          results.forEach((result, index) => {
            // Save each file's data in a separate index
            filesData.push(result);
          });

          // process data and get charts
          generateChartContent(filesData);

          // process data and get daily moods
          generateMoodsContent(filesData[filesData.length - 1].data);
        })
        .catch((err) => console.log("Something went wrong:", err));
    };

    // FUNCTIONS TO GET CHARTS

    const processData = (data) => {
      let time = [];
      let light = [];
      let humidex = [];
      let humidity = [];
      let temperature = [];

      // add data to arrays so it can be used to calculate averages
      data.map((item) => {
        time.push(item.time);
        light.push(item["light sense"]);
        humidity.push(item.humidity);
        temperature.push(item["temp (C)"]);
      });

      // convert humidity and temperature to humidex
      for (let i = 0; i < humidity.length; i++) {
        let humidityVal = humidity[i];
        let tempVal = temperature[i];
        let dewPointVal = calculateDewPoint(tempVal, humidityVal);
        let humidexVal = calculateHumidex(tempVal, dewPointVal);
        humidex.push(humidexVal);
      }

      // calculate averages for each type of data
      const avgLight = roundValue(
        light.reduce((a, b) => a + b, 0) / light.length
      );
      const avgHumidex = roundValue(
        humidex.reduce((a, b) => a + b, 0) / humidex.length
      );
      const avgHumidity = roundValue(
        humidity.reduce((a, b) => a + b, 0) / humidity.length
      );
      const avgTemperature = roundValue(
        temperature.reduce((a, b) => a + b, 0) / temperature.length
      );

      return [
        [time, light, humidex, humidity, temperature], // raw data
        [time, avgLight, avgHumidex, avgHumidity, avgTemperature], // average data
        ["time", "light", "humidex", "humidity", "temperature"], // dataName
        [
          "time: ",
          "Average light in lux: ",
          "Average humidex in 째C: ",
          "Average relative humidity in %: ",
          "Average temperature in 째C: ",
        ], // dataText
        ["line", "line", "line", "line", "line"], // type
        [
          "time: ",
          "Light in lux",
          "Humidex in 째C",
          "Relative humidity in %",
          "Temperature in 째C",
        ], // yAxis
      ];
    };

    const renderAverages = (day, data, dataName, dataText) => {
      // Render average for dataName
      document.getElementById(
        `day${day}-${dataName}`
      ).textContent += `${dataText}${data}`;
    };

    const renderAverageCellInfo = (day, data, dataText) => {
      // Render average for dataName
      const info = `<p class="cell-info">${dataText}${data}</p>`;

      document
        .getElementById(`${getDayOfWeek(day)}-cell`)
        .insertAdjacentHTML("beforeend", info);
    };

    const renderChart = (day, type, dataName, yAxis, data) => {
      let options = {
        chart: {
          type: `${type}`,
          animations: {
            enabled: false,
          },
          toolbar: {
            show: true,
            tools: {
              download: true,
              selection: false,
              zoom: true,
              zoomin: false,
              zoomout: false,
              pan: false,
              reset: true,
            },
          },
        },
        series: [
          {
            name: `${dataName}`,
            data: data[1], // specific data
          },
          {
            name: `average ${dataName}`,
            data: data[2], // specific data average
          },
        ],
        xaxis: {
          categories: data[0], // time data
          tickAmount: 15,
        },
        yaxis: {
          title: {
            text: yAxis,
          },
        },
        stroke: {
          curve: "smooth",
        },
        markers: {
          size: 0,
        },
      };

      let chart = new ApexCharts(
        document.querySelector(`#day${day}-${dataName}-graph`),
        options
      );

      chart.render();
    };

    const generateChartContent = (data) => {
      // For each day's worth of data, render charts
      for (let i = 0; i < data.length - 1; i++) {
        // format and process data
        const processedData = processData(data[i].data);

        const dataNameIndex = 2;
        const dataTextIndex = 3;
        const dataTypeIndex = 4;
        const yAxisIndex = 5;

        const rawData = processedData[0];
        const averageData = processedData[1];

        // iterate over each type of data
        for (let j = 1; j < averageData.length; j++) {
          const projectedAverageData = Array(rawData[0].length).fill(
            averageData[j]
          );
          renderAverageCellInfo(
            i + 1,
            averageData[j], // data
            processedData[dataTextIndex][j] // dataText
          );

          renderChart(
            i + 1,
            processedData[dataTypeIndex][j],
            processedData[dataNameIndex][j],
            processedData[yAxisIndex][j],
            [rawData[0], rawData[j], projectedAverageData]
          );
        }
      }
    };

    // FUNCTIONS TO GET DAILY MOODS

    const toggleCard = (day) => {
      // Get all the cards and hide them
      let allCards = document.getElementById("cards");
      let childCards = allCards.children;

      for (let i = 0; i < childCards.length; i++) {
        let child = childCards[i];
        child.style.display = "none";
      }

      // Get the clicked on a card and show it
      let card = document.getElementById(`${day}-card`);
      if (card.style.display === "block") {
        card.style.display = "none";
      } else {
        card.style.display = "block";
      }

      // Get all the headers/cells and change the background to white
      let allHeaders = document.getElementsByTagName("th");
      let allCells = document.getElementsByTagName("td");

      for (let i = 0; i < allHeaders.length; i++) {
        let header = allHeaders[i];
        header.style.backgroundColor = "white";
        let cell = allCells[i];
        cell.style.backgroundColor = "white";
      }

      // Get the clicked on day and change background to yellow
      let header = document.getElementById(`${day}-header`);
      header.style.backgroundColor = "#FFED8D";
      let cell = document.getElementById(`${day}-cell`);
      cell.style.backgroundColor = "#FFED8D";
    };

    // Create HTML elements to render daily mood info
    const renderMoodCellInfo = (day, dayNum, dayRating, sleepRating) => {
      // Render sleep ratings
      const dayMood = `<p class="cell-info">Day mood: ${dayRating}</p>`;

      document
        .getElementById(`${day}-cell`)
        .insertAdjacentHTML("beforeend", dayMood);

      const sleepQuality = `<p class="cell-info">Sleep quality: ${sleepRating}</p>`;

      document
        .getElementById(`${day}-cell`)
        .insertAdjacentHTML("beforeend", sleepQuality);

      // Render sleep and day rating in card
      document.getElementById(
        `day${dayNum}-mood`
      ).textContent += `Day mood: ${dayRating}`;

      document.getElementById(
        `day${dayNum}-sleep`
      ).textContent += `Sleep quality: ${sleepRating}`;

      // Render button to get day's info
      const linkString = `<button class="link-button" id="${day}-button">Learn more <i class="fa-solid fa-arrow-up-right-from-square"></i></button>`;

      document
        .getElementById(`${day}-cell`)
        .insertAdjacentHTML("beforeend", linkString);

      document.getElementById(`${day}-button`).onclick = function () {
        toggleCard(day);
      };
    };

    const generateMoodsContent = (data) => {
      // Iterate over each day's worth of mood data which is every other row
      for (let i = 0; i < data.length - 1; i += 2) {
        // isolate start and end objects
        let start = data[i];
        let end = data[i + 1];

        // declare variables to easily read data
        let startRating = start.rating;
        let endRating = end.rating;

        // calculate which day the data is for
        let day = i / 2 + 1;

        renderMoodCellInfo(getDayOfWeek(day), day, startRating, endRating);
      }
    };

    // HELPER FUNCTIONS

    // round to 1 decimal point
    const roundValue = (value) => {
      return Number(value.toFixed(1));
    };

    const calculateDewPoint = (tempVal, humidityVal) => {
      return tempVal - (100 - humidityVal) / 5;
    };

    const calculateHumidex = (tempVal, dewPointVal) => {
      return roundValue(
        tempVal +
          (5 / 9) *
            (6.11 *
              Math.exp(5417.753 * (1 / 273.16 - 1 / (273.15 + dewPointVal))) -
              10)
      );
    };

    const getRatingImage = (rating) => {
      if (rating === 1) {
        return "images/rating-1.png"; // mega sad face
      } else if (rating === 2) {
        return "images/rating-2.png"; // sad face
      } else if (rating === 3) {
        return "images/rating-3.png"; // ok face
      } else if (rating === 4) {
        return "images/rating-4.png"; // smiley face
      } else if (rating === 5) {
        return "images/rating-5.png"; // mega smiley face
      }
    };

    const getDayOfWeek = (day) => {
      if (day === 1) {
        return "sunday";
      } else if (day === 2) {
        return "monday";
      } else if (day === 3) {
        return "tuesday";
      } else if (day === 4) {
        return "wednesday";
      } else if (day === 5) {
        return "thursday";
      } else if (day === 6) {
        return "friday";
      } else if (day === 7) {
        return "saturday";
      }
    };

    parseFiles(filesToParse);
  </script>
</html>
