<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>SYDE 361 - Data Visualizations</title>
    <link rel="stylesheet" href="./style.css" />
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script type="text/javascript" src="papaparse.min.js"></script>
  </head>
  <body>
    <main>
      <h1>SYDE 361 - Data Visualizations</h1>
      <div>
        <h2>Day 1</h2>
        <h3>light</h3>
        <div id="day1-light"></div>
        <h3>temperature</h3>
        <div id="day1-temperature"></div>
        <h3>humidity</h3>
        <div id="day1-humidity"></div>
      </div>

      <script type="text/javascript">
        const filesToParse = [
          "https://emily.louie.ca/syde361-data/Recording_1.csv",
          "https://emily.louie.ca/syde361-data/daily_mood_ratings.csv", // daily_mood_ratings.csv must be the last one
        ];

        const parseFiles = (files) => {
          const filesData = []; // Array to save file data
          Promise.all(
            // Parse each file
            [...files].map(
              (file) =>
                new Promise((resolve, reject) =>
                  Papa.parse(file, {
                    header: true,
                    download: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: resolve, // Resolve each promise
                    error: reject, // Reject if there is an error
                  })
                )
            )
          )
            .then((results) => {
              results.forEach((result, index) => {
                // Save each file's data in a separate index
                filesData.push(result);
              });
              console.log(filesData);

              // For each day's worth of data, render charts
              for (let i = 0; i < filesData.length - 1; i++) {
                const processedData = processData(filesData[i].data);
                console.log(processedData);

                // iterate over each type of data
                for (let j = 1; j < processedData.length - 2; j++) {
                  renderChart(i + 1, processedData[5][j], processedData[4][j], [
                    processedData[0], // time data
                    processedData[j], // other specific data
                  ]);
                }
              }
            })
            .catch((err) => console.log("Something went wrong:", err));
        };

        const processData = (data) => {
          let time = [];
          let light = [];
          let humidity = [];
          let temperature = [];
          data.map((item) => {
            time.push(item.time);
            light.push(item["light sense"]);
            humidity.push(item.humidity);
            temperature.push(item["temp (C)"]);
          });
          return [
            time,
            light,
            humidity,
            temperature,
            ["time", "light", "humidity", "temperature"], // dataName
            ["line", "line", "line", "line"], // type
          ];
        };

        const renderChart = (day, type, dataName, data) => {
          console.log(day, type, dataName, data);
          let options = {
            chart: {
              type: `${type}`,
            },
            series: [
              {
                name: `${dataName}`,
                data: data[1], // specific data
              },
            ],
            xaxis: {
              categories: data[0], // time data
            },
          };

          let chart = new ApexCharts(
            document.querySelector(`#day${day}-${dataName}`),
            options
          );

          chart.render();
        };

        parseFiles(filesToParse);
      </script>
    </main>
  </body>
</html>
